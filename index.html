<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AED ì°¾ê¸°! (ì¤€ë²”ì´ì™€ í˜„ë¹ˆì´)</title>

<style>
    body {
        font-family: comic sans ms, sans-serif;
        background: #ffe66d;
        margin: 0;
        padding: 0;
        text-align: center;
    }

    h1 {
        background: #ff6b6b;
        color: white;
        padding: 20px;
        margin: 0;
        font-size: 32px;
        text-shadow: 2px 2px 0px black;
    }

    #findBtn {
        margin-top: 20px;
        padding: 15px 25px;
        font-size: 22px;
        background: #1dd1a1;
        border: none;
        border-radius: 10px;
        color: white;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 3px 3px 0px black;
    }
    #findBtn:hover {
        background: #10ac84;
    }

    #result {
        margin: 20px;
        text-align: left;
        padding: 10px;
    }

    .card {
        background: white;
        margin: 10px 0;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 3px 3px 0px black;
        border-left: 10px solid #ff6b6b;
    }

    .loading {
        font-size: 24px;
        margin-top: 20px;
        animation: blink 1s infinite alternate;
    }

    @keyframes blink {
        0% { opacity: 0.2; }
        100% { opacity: 1; }
    }
</style>
</head>

<body>

<h1>ğŸ”¥ ë‚´ ì£¼ë³€ AED ì°¾ê¸° ğŸ”¥<br><small>ê²½ê¸°ë„ ë°ì´í„° ê¸°ë°˜</small></h1>

<button id="findBtn">ğŸ“¡ ë‚´ ì£¼ë³€ì—ì„œ AED ì°¾ê¸°!</button>

<div id="status" class="loading"></div>
<div id="result"></div>

<script>
// ---------------------------
// ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine)
// ---------------------------
function getDistance(lat1, lon1, lat2, lon2) {
    function deg2rad(d) { return d * (Math.PI / 180); }
    const R = 6371; // km
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
        Math.sin(dLat/2)**2 +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon/2)**2;

    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// ---------------------------
// AED ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
// ---------------------------
async function fetchAED() {
    const url =
        `https://openapi.gg.go.kr/Publtolt?KEY=b8d51375948e422eb4d6c7b0a38b1cbc&Type=json&pIndex=1&pSize=1000`;

    const res = await fetch(url);
    const json = await res.json();
    return json.Publtolt[1].row;
}

// ---------------------------
// ë©”ì¸ ê¸°ëŠ¥: ë‚´ ìœ„ì¹˜ ê¸°ë°˜ ê²€ìƒ‰
// ---------------------------
document.getElementById("findBtn").onclick = function () {
    const status = document.getElementById("status");
    const result = document.getElementById("result");

    status.innerHTML = "ğŸ“ ìœ„ì¹˜ ì°¾ëŠ” ì¤‘...";
    result.innerHTML = "";

    navigator.geolocation.getCurrentPosition(async pos => {
        status.innerHTML = "ğŸ“¡ AED ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

        const myLat = pos.coords.latitude;
        const myLon = pos.coords.longitude;

        const data = await fetchAED();

        const nearby = [];

        data.forEach(aed => {
            const lat = parseFloat(aed.REFINE_WGS84_LAT);
            const lon = parseFloat(aed.REFINE_WGS84_LOGT);

            if (!lat || !lon) return;

            const dist = getDistance(myLat, myLon, lat, lon);

            if (dist < 3) { // ë°˜ê²½ 3km
                nearby.push({
                    ...aed,
                    distance: dist
                });
            }
        });

        if (nearby.length === 0) {
            status.innerHTML = "ğŸ˜¢ ì£¼ë³€ 3km ë‚´ AED ì—†ìŒ";
            return;
        }

        status.innerHTML = `âœ¨ ì£¼ë³€ AED ${nearby.length}ê°œ ë°œê²¬!`;

        nearby.sort((a, b) => a.distance - b.distance);

        nearby.forEach(a => {
            result.innerHTML += `
                <div class="card">
                    <b>ğŸ“ ${a.BULD_NM || "ì´ë¦„ ì—†ìŒ"}</b><br>
                    ì£¼ì†Œ: ${a.REFINE_ROADNM_ADDR}<br>
                    ìš´ì˜ê¸°ê´€: ${a.MANAGE_INST_NM || "ì •ë³´ ì—†ìŒ"}<br>
                    ì „í™”ë²ˆí˜¸: ${a.MANAGE_INST_TEL || "ì—†ìŒ"}<br>
                    ê±°ë¦¬: ${a.distance.toFixed(2)} km
                </div>
            `;
        });

    }, err => {
        status.innerHTML = "â— ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤!";
    });
};
</script>

</body>
</html>
